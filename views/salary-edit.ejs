<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edit Salary</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <h3>Edit Salary — <%= salary.employeeId.name %> — <%= month.monthName %> <%= month.year %></h3>

    <form method="POST" class="row g-3">

      <!-- Monthly Salary -->
      <div class="col-md-2">
        <label class="form-label">Monthly Salary</label>
        <input name="monthlySalary" id="monthlySalary" class="form-control"
               value="<%= salary.monthlySalary %>" readonly>
      </div>

      <!-- Working Hours -->
      <div class="col-md-2">
        <label class="form-label">Actual Working Hours</label>
        <input name="workingHours" id="workingHours" class="form-control"
               value="<%= salary.workingHours %>" type="number">
        <small class="text-muted">Required: <%= month.workingDays * 8 %> hrs</small>
      </div>

      <!-- OT -->
      <div class="col-md-2">
        <label class="form-label">OT Hours</label>
        <input name="otHours" id="otHours" class="form-control"
               type="number" value="<%= salary.otHours %>">
      </div>

      <div class="col-md-2">
        <label class="form-label">OT Rate / Hour</label>
        <input name="otRate" id="otRate" class="form-control"
               type="number" value="<%= salary.otRate %>">
      </div>

      <!-- Earnings -->
      <div class="col-md-2">
        <label class="form-label">Bonus</label>
        <input name="bonus" id="bonus" class="form-control" type="number"
               value="<%= salary.bonus %>">
      </div>

      <div class="col-md-2">
        <label class="form-label">Allowance</label>
        <input name="allowance" id="allowance" class="form-control" type="number"
               value="<%= salary.allowance %>">
      </div>

      <!-- Advance & Notes -->
      <div class="col-md-2">
        <label class="form-label">Advance</label>
        <input name="advance" id="advance" class="form-control" type="number"
               value="<%= salary.advance %>">
      </div>

      <div class="col-md-4">
        <label class="form-label">Advance Note</label>
        <input name="advanceNote" id="advanceNote" class="form-control"
               value="<%= salary.advanceNote %>">
      </div>

      <!-- Other Deduction -->
      <div class="col-md-2">
        <label class="form-label">Other Deductions</label>
        <input name="otherDeductions" id="otherDeductions" class="form-control" type="number"
               value="<%= salary.otherDeductions %>">
      </div>

      <!-- NET Salary -->
      <div class="col-md-12 mt-3">
        <h4>Net Salary: <strong id="netSalary"><%= salary.netSalary %></strong></h4>
        <button class="btn btn-primary">Update Salary</button>
      </div>

    </form>
  </div>

<script>
function toNum(v){ return Number(v || 0); }

function recalc(){
  const monthly = toNum(document.getElementById('monthlySalary').value);
  const workingHours = toNum(document.getElementById('workingHours').value);

  const requiredHours = <%= month.workingDays %> * 8;
  const totalDays = <%= month.totalDays %>;

  // Hour → Leave Calculation
  const absentHours = Math.max(0, requiredHours - workingHours);
  const leaveDays = absentHours / 8;

  const perDaySalary = totalDays > 0 ? monthly / totalDays : 0;
  const leaveDeduction = perDaySalary * leaveDays;

  // OT
  const otAmount = toNum(document.getElementById('otHours').value) *
                   toNum(document.getElementById('otRate').value);

  // Earnings
  const bonus = toNum(document.getElementById('bonus').value);
  const allowance = toNum(document.getElementById('allowance').value);

  // Deductions
  const advance = toNum(document.getElementById('advance').value);
  const other = toNum(document.getElementById('otherDeductions').value);

  const totalDeductions = leaveDeduction + advance + other;

  // FINAL NET SALARY
  const net = monthly + otAmount + bonus + allowance - totalDeductions;

  document.getElementById('netSalary').innerText = net.toFixed(2);
}

// Auto recalc when fields update
['#workingHours', '#otHours', '#otRate', '#bonus',
 '#allowance', '#advance', '#otherDeductions']
.forEach(sel => {
  document.querySelector(sel).addEventListener('input', recalc);
});
</script>

</body>
</html>
