<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Create Salary</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/header') %>

  <div class="container mt-4">
    <h3>Create Salary for <%= month.monthName %> <%= month.year %></h3>

    <form method="POST" class="row g-3">

      <!-- Employee -->
      <div class="col-md-6">
        <label class="form-label">Select Employee</label>
        <select name="employeeId" id="employeeId" class="form-select" required onchange="loadEmp()">
          <option value="">Select Employee</option>
          <% employees.forEach(e => { %>
            <option value="<%= e._id %>" data-monthly="<%= e.monthlySalary %>">
              <%= e.name %> — Rs.<%= e.monthlySalary %>/month
            </option>
          <% }) %>
        </select>
      </div>

      <!-- Monthly Salary -->
      <div class="col-md-2">
        <label class="form-label">Monthly Salary</label>
        <input name="monthlySalary" id="monthlySalary" class="form-control" readonly>
      </div>

      <!-- Working Hours -->
      <div class="col-md-2">
        <label class="form-label">Actual Working Hours</label>
        <input name="workingHours" id="workingHours" class="form-control" type="number"
               value="<%= month.totalWorkingHours %>">
        <small class="text-muted">Month Required: <%= month.totalWorkingHours %> hrs</small>
      </div>

      <!-- OT -->
      <div class="col-md-2">
        <label class="form-label">OT Hours</label>
        <input name="otHours" id="otHours" class="form-control" type="number" value="0">
      </div>

      <div class="col-md-2">
        <label class="form-label">OT Rate / Hour</label>
        <input name="otRate" id="otRate" class="form-control" type="number" value="0">
      </div>

      <!-- Earnings -->
      <div class="col-md-2">
        <label class="form-label">Bonus</label>
        <input name="bonus" id="bonus" class="form-control" type="number" value="0">
      </div>

      <div class="col-md-2">
        <label class="form-label">Allowance</label>
        <input name="allowance" id="allowance" class="form-control" type="number" value="0">
      </div>

      <!-- Advance -->
      <div class="col-md-2">
        <label class="form-label">Advance</label>
        <input name="advance" id="advance" class="form-control" type="number" value="0">
      </div>

      <div class="col-md-4">
        <label class="form-label">Advance Note</label>
        <input name="advanceNote" id="advanceNote" class="form-control">
      </div>

      <!-- Other Deductions -->
      <div class="col-md-2">
        <label class="form-label">Other Deductions</label>
        <input name="otherDeductions" id="otherDeductions" class="form-control" type="number" value="0">
      </div>

      <!-- Net Salary -->
      <div class="col-md-12 mt-3">
        <div class="d-flex align-items-center">
          <h4 class="me-4">Net Salary: <strong id="netSalary">0</strong></h4>
          <button class="btn btn-success ms-auto">Save Salary</button>
        </div>
      </div>
    </form>
  </div>


<script>
function toNum(v){ return Number(v || 0); }

function recalc(){
  const monthly = toNum(document.getElementById('monthlySalary').value);
  const workingHours = toNum(document.getElementById('workingHours').value);

  const requiredHours = <%= month.workingDays %> * 8;
  const totalDays = <%= month.totalDays %>;

  // Hour → Leave Calculation
  const absentHours = Math.max(0, requiredHours - workingHours);
  const leaveDays = absentHours / 8;

  const perDay = monthly / totalDays;
  const leaveDeduction = perDay * leaveDays;

  // OT
  const otAmount = toNum(document.getElementById('otHours').value) *
                   toNum(document.getElementById('otRate').value);

  // Earnings
  const bonus = toNum(document.getElementById('bonus').value);
  const allowance = toNum(document.getElementById('allowance').value);

  // Deductions
  const advance = toNum(document.getElementById('advance').value);
  const other = toNum(document.getElementById('otherDeductions').value);

  const totalDeductions = leaveDeduction + advance + other;

  // FINAL
  const net = monthly + otAmount + bonus + allowance - totalDeductions;

  document.getElementById('netSalary').innerText = net.toFixed(2);
}

function loadEmp(){
  const opt = document.querySelector('#employeeId option:checked');
  document.getElementById('monthlySalary').value = opt ? opt.getAttribute('data-monthly') : 0;
  recalc();
}

// Auto recalc on change
['#employeeId', '#workingHours', '#otHours', '#otRate', '#bonus',
 '#allowance', '#advance', '#otherDeductions'].forEach(sel => {
  document.querySelector(sel).addEventListener('input', recalc);
});
</script>

</body>
</html>
